// index.js
require('dotenv').config();
const fs = require('fs');
const TelegramBot = require('node-telegram-bot-api');

const token = process.env.BOT_TOKEN;
if (!token) {
  console.error("‚ùå BOT_TOKEN –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ .env");
  process.exit(1);
}

const bot = new TelegramBot(token, { polling: true });
console.log("‚úÖ Resucitaci√≥n_Shock_Bot –∑–∞–ø—É—â–µ–Ω...");

// --- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
function mainMenu() {
  return {
    reply_markup: {
      keyboard: [
        ["ü´Ä –†–µ–∞–Ω–∏–º–∞—Ü–∏—è (–°–õ–†)", "‚ö° –®–æ–∫"],
        ["üöë –¢—Ä–∞–≤–º–∞", "üî• –û–∂–æ–≥–∏"],
        ["üìò –°–∫–∞—á–∞—Ç—å –∞–ª–≥–æ—Ä–∏—Ç–º—ã –°–ú–ü", "üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã"]
      ],
      resize_keyboard: true
    },
    parse_mode: "Markdown"
  };
}

// --- Inline –º–µ–Ω—é –¥–ª—è –®–û–ö
function shockInline() {
  return {
    reply_markup: {
      inline_keyboard: [
        [
          { text: "ü©∏ –¢—Ä–∞–≤–º–∞—Ç–∏—á–µ—Å–∫–∏–π", callback_data: "trauma_shock" },
          { text: "üíâ –ì–µ–º–æ—Ä—Ä–∞–≥–∏—á–µ—Å–∫–∏–π", callback_data: "hemo_shock" }
        ],
        [
          { text: "üî• –û–∂–æ–≥–æ–≤—ã–π", callback_data: "burn_shock" },
          { text: "ü§ß –ê–Ω–∞—Ñ–∏–ª–∞–∫—Ç–∏—á–µ—Å–∫–∏–π", callback_data: "ana_shock" }
        ],
        [
          { text: "ü¶† –ò–Ω—Ñ–µ–∫—Ü–∏–æ–Ω–Ω–æ-—Ç–æ–∫—Å–∏—á–µ—Å–∫–∏–π", callback_data: "toxic_shock" }
        ],
        [
          { text: "üìò –°–∫–∞—á–∞—Ç—å –≥–ª–∞–≤—É (PDF)", callback_data: "shock_pdf" },
          { text: "‚Ü©Ô∏è –ù–∞–∑–∞–¥", callback_data: "main_back" }
        ]
      ]
    },
    parse_mode: "Markdown"
  };
}

// --- –ö–æ–º–∞–Ω–¥–∞ /start
bot.onText(/\/start/, (msg) => {
  bot.sendMessage(
    msg.chat.id,
    "üö® *Resucitaci√≥n_Shock_Bot v1.0*\n\n" +
    "üß† –ü–æ–º–æ—â–Ω–∏–∫ –¥–ª—è —Ñ–µ–ª—å–¥—à–µ—Ä–æ–≤ –∏ –º–µ–¥–∏–∫–æ–≤ –°–ú–ü.\n" +
    "–í—ã–±–µ—Ä–∏ —Ä–∞–∑–¥–µ–ª üëá",
    mainMenu()
  );
});

// --- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±—ã—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
bot.on('message', (msg) => {
  const text = msg.text || '';
  const chatId = msg.chat.id;

  if (text === "‚ö° –®–æ–∫") {
    return bot.sendMessage(chatId, "‚ö° –í—ã–±–µ—Ä–∏ —Ç–∏–ø —à–æ–∫–∞:", shockInline());
  }

  if (text === "üìò –°–∫–∞—á–∞—Ç—å –∞–ª–≥–æ—Ä–∏—Ç–º—ã –°–ú–ü") {
    const pdfPath = "./Algoritms_2018.pdf";
    if (fs.existsSync(pdfPath)) {
      return bot.sendDocument(chatId, fs.createReadStream(pdfPath));
    } else {
      return bot.sendMessage(chatId, "‚ùå PDF –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–º–µ—Å—Ç–∏ *Algoritms_2018.pdf* —Ä—è–¥–æ–º —Å index.js", { parse_mode: "Markdown" });
    }
  }

  if (text === "üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã") {
    return bot.sendMessage(chatId,
      "üë®‚Äç‚öïÔ∏è *–ö–æ–Ω—Ç–∞–∫—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞:*\n" +
      "üìç Telegram: @MSL72Rph\n" +
      "ü§ñ –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞: *TARS Systems AI Lab*\n" +
      "üöë –ü–æ–¥–¥–µ—Ä–∂–∫–∞: *–§–µ–ª—å–¥—à–µ—Ä—ã –°–ú–ü –†–æ—Å—Å–∏–∏*",
      { parse_mode: "Markdown" }
    );
  }

  bot.sendMessage(chatId, "–í—ã–±–µ—Ä–∏ —Ä–∞–∑–¥–µ–ª –∏–∑ –º–µ–Ω—é üëá", mainMenu());
});

// --- –û–±—Ä–∞–±–æ—Ç–∫–∞ Inline callback
bot.on('callback_query', (query) => {
  const chatId = query.message.chat.id;
  const data = query.data;
  bot.answerCallbackQuery(query.id).catch(() => {});

  if (data === "trauma_shock") {
    return bot.sendMessage(chatId,
      "ü©∏ *–¢—Ä–∞–≤–º–∞—Ç–∏—á–µ—Å–∫–∏–π —à–æ–∫*\n\n" +
      "üìñ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ: –æ—Å—Ç—Ä–∞—è –Ω–µ—Å–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫—Ä–æ–≤–æ–æ–±—Ä–∞—â–µ–Ω–∏—è –ø—Ä–∏ —Ç—è–∂–µ–ª—ã—Ö —Ç—Ä–∞–≤–º–∞—Ö, –∫—Ä–æ–≤–æ–ø–æ—Ç–µ—Ä–µ, –±–æ–ª–∏.\n\n" +
      "üíä *–ê–ª–≥–æ—Ä–∏—Ç–º:*\n" +
      "1Ô∏è‚É£ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫—Ä–æ–≤–æ—Ç–µ—á–µ–Ω–∏–µ.\n" +
      "2Ô∏è‚É£ –û–±–µ—Å–ø–µ—á–∏—Ç—å –≤–µ–Ω–æ–∑–Ω—ã–π –¥–æ—Å—Ç—É–ø, –ø–æ–¥–∞—á–∞ O‚ÇÇ.\n" +
      "3Ô∏è‚É£ –ò–Ω—Ñ—É–∑–∏–æ–Ω–Ω–∞—è —Ç–µ—Ä–∞–ø–∏—è (–∫—Ä–∏—Å—Ç–∞–ª–ª–æ–∏–¥—ã 800‚Äì1000 –º–ª).\n" +
      "4Ô∏è‚É£ –ê–Ω–∞–ª—å–≥–µ–∑–∏—è: —Ñ–µ–Ω—Ç–∞–Ω–∏–ª + –¥–∏–∞–∑–µ–ø–∞–º.\n" +
      "5Ô∏è‚É£ –ò–º–º–æ–±–∏–ª–∏–∑–∞—Ü–∏—è, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –≤ —Ç–µ—á–µ–Ω–∏–µ ¬´–∑–æ–ª–æ—Ç–æ–≥–æ —á–∞—Å–∞¬ª.\n\n" +
      "üßÆ *–®–∫–∞–ª–∞ —à–æ–∫–æ–≥–µ–Ω–Ω–æ—Å—Ç–∏:*\n" +
      "```\n1 –±–∞–ª–ª ‚Äì –ª—ë–≥–∫–∏–µ –ø–µ—Ä–µ–ª–æ–º—ã\n3‚Äì4 ‚Äì –ø–µ—Ä–µ–ª–æ–º –ø–ª–µ—á–∞ / –≥–æ–ª–µ–Ω–∏\n6‚Äì7 ‚Äì –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–µ—Ä–µ–ª–æ–º—ã\n12 ‚Äì —Ç—Ä–∞–≤–º–∞ –∂–∏–≤–æ—Ç–∞\n\nI —Å—Ç–µ–ø–µ–Ω—å: 5‚Äì10 –±–∞–ª–ª–æ–≤\nII —Å—Ç–µ–ø–µ–Ω—å: 11‚Äì15 –±–∞–ª–ª–æ–≤\nIII —Å—Ç–µ–ø–µ–Ω—å: >15 –±–∞–ª–ª–æ–≤\n```",
      { parse_mode: "Markdown" }
    );
  }

  if (data === "hemo_shock") {
    return bot.sendMessage(chatId,
      "üíâ *–ì–µ–º–æ—Ä—Ä–∞–≥–∏—á–µ—Å–∫–∏–π —à–æ–∫*\n\n" +
      "üìñ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ: –º–∞—Å—Å–∏–≤–Ω–∞—è –∫—Ä–æ–≤–æ–ø–æ—Ç–µ—Ä—è ‚Üí ‚Üì–û–¶–ö, ‚Üì–¥–∞–≤–ª–µ–Ω–∏–µ, –≥–∏–ø–æ–∫—Å–∏—è.\n\n" +
      "üíä *–ê–ª–≥–æ—Ä–∏—Ç–º:*\n" +
      "1Ô∏è‚É£ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫—Ä–æ–≤–æ—Ç–µ—á–µ–Ω–∏—è.\n" +
      "2Ô∏è‚É£ –ò–Ω—Ñ—É–∑–∏—è –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–∏–¥–æ–≤/–∫–æ–ª–ª–æ–∏–¥–æ–≤.\n" +
      "3Ô∏è‚É£ –≠—Ç–∞–º–∑–∏–ª–∞—Ç, —Ç—Ä–∞–Ω–µ–∫—Å–∞–º–æ–≤–∞—è –∫–∏—Å–ª–æ—Ç–∞.\n" +
      "4Ô∏è‚É£ –î–æ—Ñ–∞–º–∏–Ω –ø—Ä–∏ –ê–î < 90 –º–º.—Ä—Ç.—Å—Ç.\n" +
      "5Ô∏è‚É£ –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –≤ –ø–æ–ª–æ–∂–µ–Ω–∏–∏ –¢—Ä–µ–Ω–¥–µ–ª–µ–Ω–±—É—Ä–≥–∞.",
      { parse_mode: "Markdown" }
    );
  }

  if (data === "burn_shock") {
    return bot.sendMessage(chatId,
      "üî• *–û–∂–æ–≥–æ–≤—ã–π —à–æ–∫*\n\n" +
      "üìñ –í–æ–∑–Ω–∏–∫–∞–µ—Ç –ø—Ä–∏ –æ–±—à–∏—Ä–Ω—ã—Ö –æ–∂–æ–≥–∞—Ö –∫–æ–∂–∏ –∏ —Ç–∫–∞–Ω–µ–π.\n\n" +
      "üíä *–ê–ª–≥–æ—Ä–∏—Ç–º:*\n" +
      "1Ô∏è‚É£ –í–µ–Ω–æ–∑–Ω—ã–π –¥–æ—Å—Ç—É–ø.\n" +
      "2Ô∏è‚É£ –ò–Ω–≥–∞–ª—è—Ü–∏—è O‚ÇÇ.\n" +
      "3Ô∏è‚É£ –ò–Ω—Ñ—É–∑–∏—è 4 –º–ª √ó –º–∞—Å—Å–∞ (–∫–≥) √ó % –æ–∂–æ–≥–∞ (–ø–æ —Ñ–æ—Ä–º—É–ª–µ –ü–∞—Ä–∫–ª–∞–Ω–¥–∞).\n" +
      "4Ô∏è‚É£ –§–µ–Ω—Ç–∞–Ω–∏–ª + –¥–∏–∞–∑–µ–ø–∞–º.\n" +
      "5Ô∏è‚É£ –ê—Å–µ–ø—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–≤—è–∑–∫–∏, —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞.",
      { parse_mode: "Markdown" }
    );
  }

  if (data === "ana_shock") {
    return bot.sendMessage(chatId,
      "ü§ß *–ê–Ω–∞—Ñ–∏–ª–∞–∫—Ç–∏—á–µ—Å–∫–∏–π —à–æ–∫*\n\n" +
      "üìñ –ê–ª–ª–µ—Ä–≥–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–∫—Ü–∏—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ —Ç–∏–ø–∞, –∫–æ–ª–ª–∞–ø—Å –∏ –±—Ä–æ–Ω—Ö–æ—Å–ø–∞–∑–º.\n\n" +
      "üíä *–ê–ª–≥–æ—Ä–∏—Ç–º:*\n" +
      "1Ô∏è‚É£ –ê–¥—Ä–µ–Ω–∞–ª–∏–Ω –≤/–º 0.3‚Äì0.5 –º–≥.\n" +
      "2Ô∏è‚É£ –í/–≤ –¥–æ—Å—Ç—É–ø, –≥–ª—é–∫–æ–∫–æ—Ä—Ç–∏–∫–æ–∏–¥—ã.\n" +
      "3Ô∏è‚É£ –ò–Ω—Ñ—É–∑–∏—è 20 –º–ª/–∫–≥.\n" +
      "4Ô∏è‚É£ O‚ÇÇ, –±—Ä–æ–Ω—Ö–æ–ª–∏—Ç–∏–∫–∏.\n" +
      "5Ô∏è‚É£ –ü—Ä–∏ –≥–∏–ø–æ—Ç–æ–Ω–∏–∏ ‚Äî –¥–æ—Ñ–∞–º–∏–Ω.",
      { parse_mode: "Markdown" }
    );
  }

  if (data === "toxic_shock") {
    return bot.sendMessage(chatId,
      "ü¶† *–ò–Ω—Ñ–µ–∫—Ü–∏–æ–Ω–Ω–æ-—Ç–æ–∫—Å–∏—á–µ—Å–∫–∏–π —à–æ–∫*\n\n" +
      "üìñ –†–∞–∑–≤–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–µ–ø—Å–∏—Å–µ, –∏–Ω—Ç–æ–∫—Å–∏–∫–∞—Ü–∏–∏, –≥–∏–ø–æ–ø–µ—Ä—Ñ—É–∑–∏–∏ —Ç–∫–∞–Ω–µ–π.\n\n" +
      "üíä *–ê–ª–≥–æ—Ä–∏—Ç–º:*\n" +
      "1Ô∏è‚É£ –ü–æ–ª–æ–∂–µ–Ω–∏–µ –¢—Ä–µ–Ω–¥–µ–ª–µ–Ω–±—É—Ä–≥–∞.\n" +
      "2Ô∏è‚É£ –ò–Ω—Ñ—É–∑–∏—è –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–∏–¥–æ–≤.\n" +
      "3Ô∏è‚É£ –ì–ª—é–∫–æ–∫–æ—Ä—Ç–∏–∫–æ–∏–¥—ã 120 –º–≥.\n" +
      "4Ô∏è‚É£ O‚ÇÇ, –∞–Ω—Ç–∏–±–∞–∫—Ç–µ—Ä–∏–∞–ª—å–Ω–∞—è —Ç–µ—Ä–∞–ø–∏—è.\n" +
      "5Ô∏è‚É£ –ü—Ä–∏ –≥–∏–ø–æ—Ç–æ–Ω–∏–∏ ‚Äî –¥–æ—Ñ–∞–º–∏–Ω.",
      { parse_mode: "Markdown" }
    );
  }

  if (data === "shock_pdf") {
    const pdf = "./Algoritms_2018.pdf";
    if (fs.existsSync(pdf)) {
      return bot.sendDocument(chatId, fs.createReadStream(pdf));
    } else {
      return bot.sendMessage(chatId, "üìï –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–º–µ—Å—Ç–∏ *Algoritms_2018.pdf* —Ä—è–¥–æ–º —Å index.js", { parse_mode: "Markdown" });
    }
  }

  if (data === "main_back") {
    return bot.sendMessage(chatId, "‚Ü©Ô∏è –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.", mainMenu());
  }
});
